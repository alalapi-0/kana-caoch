# Kana Coach Â· å¾®ä¿¡å°ç¨‹åº + Node/Express Mock æœåŠ¡

## é¡¹ç›®ç®€ä»‹
Kana Coach æ˜¯ä¸€ä¸ªé’ˆå¯¹æ—¥è¯­å­¦ä¹ è€…çš„æœ€å°å¯è¡Œäº§å“ï¼ˆMVPï¼‰ï¼Œç”±å¾®ä¿¡å°ç¨‹åºå‰ç«¯ä¸ Node/Express æ¨¡æ‹ŸæœåŠ¡ç«¯ç»„æˆã€‚å½“å‰ç‰ˆæœ¬èšç„¦ä¸¤ä¸ªæ ¸å¿ƒç»ƒä¹ åœºæ™¯ï¼š

- **äº”åéŸ³æµ‹éªŒ**ï¼šæœ¬åœ°æ ¹æ®ç¼–è¾‘è·ç¦»è®¡ç®—å‡†ç¡®ç‡ä¸æ˜Ÿçº§ï¼Œå¸®åŠ©å·©å›ºå‡åä¸ç½—é©¬éŸ³ã€‚
- **è·Ÿè¯»è®­ç»ƒ**ï¼šè°ƒç”¨ Mock TTS æ¥å£è·å–å ä½éŸ³é¢‘ã€å½•éŸ³ä¸Šä¼ è‡³ Mock ASR æ¥å£ï¼Œå¹¶åŸºäºè¯é”™è¯¯ç‡ï¼ˆWERï¼‰è¿”å›è¯„åˆ†ä¸æ˜Ÿçº§ã€‚

> **è·¯çº¿å›¾é¢„å‘Š**ï¼šåç»­å°†é€æ­¥æ¥å…¥è…¾è®¯äº‘ TTS/ASR/COSï¼Œæ‰©å……è¯åº“ä¸ä¾‹å¥ï¼Œå®Œå–„è¿›åº¦å­˜å‚¨ä¸ç”¨æˆ·ä½“ç³»ã€‚

## åŠŸèƒ½æ¸…å•
- âœ… é¦–é¡µå¡ç‰‡å…¥å£ï¼Œä¸²è”æµ‹éªŒä¸è·Ÿè¯»è®­ç»ƒã€‚
- âœ… äº”åéŸ³æµ‹éªŒï¼šéšæœºæŠ½é¢˜ã€æœ¬åœ°è¯„åˆ†ã€æ˜Ÿçº§ç»„ä»¶å³æ—¶åé¦ˆã€‚
- âœ… è·Ÿè¯»è®­ç»ƒï¼šç¤ºä¾‹æ’­æ”¾ã€å½•éŸ³ä¸Šä¼ ã€Mock è¯†åˆ«ç»“æœå±•ç¤ºã€‚
- âœ… ç»“æœé¡µï¼šèšåˆæµ‹éªŒä¸è·Ÿè¯»æˆç»©ï¼Œå¯é‡æ–°è¿›å…¥ç»ƒä¹ ã€‚
- âœ… è®¾ç½®é¡µï¼šå ä½è¯­é€Ÿ/æ’­éŸ³äººé€‰é¡¹ï¼Œå¹¶å…è®¸é…ç½®åç«¯ BASE_URLã€‚
- âœ… æœåŠ¡ç«¯ï¼š`/tts`ã€`/asr/recognize`ã€`/progress` è·¯ç”±ï¼›è¯„åˆ†ç®—æ³•ä¸å•å…ƒæµ‹è¯•ã€‚
- ğŸ”œ è®¡åˆ’å¢å¼ºï¼šè…¾è®¯äº‘èƒ½åŠ›å¯¹æ¥ã€ç”¨æˆ·ç™»å½•ã€æ•°æ®æŒä¹…åŒ–ã€æ›´å¤šé¢˜å‹ã€‚

## ç›®å½•ç»“æ„
```
kana-coach/
â”œâ”€ README.md                     # ä½¿ç”¨æŒ‡å—ä¸å¼€å‘æ–‡æ¡£
â”œâ”€ package.json                  # æ ¹å·¥ä½œåŒºè„šæœ¬ï¼ˆbootstrap/dev/testï¼‰
â”œâ”€ pnpm-workspace.yaml           # pnpm å·¥ä½œåŒºå®šä¹‰
â”œâ”€ .editorconfig                 # è·¨ç¼–è¾‘å™¨ç»Ÿä¸€æ ¼å¼
â”œâ”€ .prettierrc                   # Prettier è§„åˆ™
â”œâ”€ .eslintrc.cjs                 # ESLint é…ç½®
â”œâ”€ .gitignore                    # å¿½ç•¥ä¾èµ–ã€äºŒè¿›åˆ¶åŠå·¥å…·ç¼“å­˜
â”œâ”€ .gitattributes                # æ–‡æœ¬å½’ä¸€åŒ–ä¸äºŒè¿›åˆ¶ä¿æŠ¤
â”œâ”€ shared/                       # å‰åç«¯å…±äº«æ•°æ®ï¼ˆçº¯æ–‡æœ¬ï¼‰
â”‚  â”œâ”€ kana.json                  # å‡åä¸ç½—é©¬éŸ³æ ·æœ¬ï¼ˆ10 æ¡ï¼‰
â”‚  â””â”€ sentences.json             # æ—¥è¯­ä¾‹å¥ï¼ˆ5 æ¡ï¼‰
â”œâ”€ miniprogram/                  # å¾®ä¿¡å°ç¨‹åºï¼ˆTypeScriptï¼‰
â”‚  â”œâ”€ project.config.json        # å¾®ä¿¡å¼€å‘è€…å·¥å…·é…ç½®
â”‚  â”œâ”€ tsconfig.json              # å°ç¨‹åº TS ç¼–è¯‘é…ç½®
â”‚  â”œâ”€ app.(ts/json/wxss)         # å…¨å±€å…¥å£ä¸æ ·å¼
â”‚  â”œâ”€ utils/                     # APIã€å½•éŸ³ã€è¯„åˆ†å·¥å…·
â”‚  â”œâ”€ components/star-rating/    # æ˜Ÿçº§å±•ç¤ºç»„ä»¶
â”‚  â””â”€ pages/                     # home/kana-quiz/shadowing/result/settings
â””â”€ server/                       # Node/Express Mock æœåŠ¡ç«¯ï¼ˆTypeScriptï¼‰
   â”œâ”€ package.json               # æœåŠ¡ç«¯ä¾èµ–ä¸è„šæœ¬
   â”œâ”€ tsconfig.json              # æœåŠ¡ç«¯ TS ç¼–è¯‘é…ç½®
   â”œâ”€ .env.example               # ç¯å¢ƒå˜é‡ç¤ºä¾‹
   â””â”€ src/
      â”œâ”€ index.ts                # Express å¯åŠ¨å…¥å£
      â”œâ”€ routes/                 # tts/asr/progress è·¯ç”±
      â”œâ”€ services/               # è…¾è®¯äº‘å ä½æœåŠ¡ã€å­˜å‚¨å·¥å…·
      â”œâ”€ lib/score.ts            # è¯„åˆ†ç®—æ³•ï¼ˆLevenshtein/WER/æ˜Ÿçº§ï¼‰
      â””â”€ tests/score.test.ts     # Vitest å•å…ƒæµ‹è¯•
```

## ç¯å¢ƒè¦æ±‚
- Node.js â‰¥ 18ï¼ˆå»ºè®® LTS ç‰ˆæœ¬ï¼‰
- [pnpm](https://pnpm.io/) â‰¥ 8
- å¾®ä¿¡å¼€å‘è€…å·¥å…· â‰¥ 1.06.2405150ï¼ˆæ”¯æŒ TypeScript é¡¹ç›®å¯¼å…¥ï¼‰
- ï¼ˆå¯é€‰ï¼‰Vitest CLIï¼Œç”¨äºè¿è¡Œåç«¯å•æµ‹

## å®‰è£…ä¸å¯åŠ¨
```bash
pnpm -w install        # å®‰è£…å·¥ä½œåŒºæ‰€æœ‰ä¾èµ–
pnpm dev:server        # åœ¨ 3000 ç«¯å£å¯åŠ¨ Express Mock æœåŠ¡
```
> é¦–æ¬¡æ‰§è¡Œ `pnpm -w install` ä¼šå®‰è£… miniprogram ä¸ server å­åŒ…ä¾èµ–ï¼›è¯·ç¡®ä¿å·²å¼€å¯å¤–ç½‘ä»£ç†æˆ–ä½¿ç”¨ç¦»çº¿é•œåƒã€‚

## åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­å¯¼å…¥å°ç¨‹åº
1. æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼Œé€‰æ‹© **å¯¼å…¥é¡¹ç›®**ã€‚
2. é¡¹ç›®ç›®å½•é€‰æ‹©ä»“åº“å†…çš„ `miniprogram/` æ–‡ä»¶å¤¹ã€‚
3. AppID å»ºè®®ä½¿ç”¨ã€Œæµ‹è¯•å·ã€æˆ–ç•™ç©ºæ¸¸å®¢æ¨¡å¼ï¼ˆå·¥å…·ä¼šæç¤ºä»…ä¾›è°ƒè¯•ï¼‰ã€‚
4. **ç¼–è¯‘è®¾ç½®**ï¼šå¼€å¯ã€Œä½¿ç”¨ npm æ¨¡å—ã€æ— éœ€å®‰è£…é¢å¤–ä¾èµ–ï¼›å¦‚éœ€ ES6 è½¬ ES5 å¯ä¿æŒé»˜è®¤ã€‚
5. è‹¥éœ€è”è°ƒæœåŠ¡ç«¯ï¼Œåœ¨å·¥å…·çš„ã€Œæœ¬åœ°è®¾ç½®ã€ä¸­å‹¾é€‰ã€Œä¸æ ¡éªŒåˆæ³•åŸŸåã€ã€‚

## å¯åŠ¨å‰åç«¯è”è°ƒæµç¨‹
1. ç»ˆç«¯æ‰§è¡Œ `pnpm dev:server`ï¼Œç¡®è®¤æ—¥å¿—è¾“å‡º `Kana Coach server listening on port 3000`ã€‚
2. åœ¨å°ç¨‹åºè®¾ç½®é¡µã€Œåç«¯åœ°å€ã€ä¸­å¡«å†™ `http://localhost:3000` å¹¶ä¿å­˜ã€‚
3. è¿›å…¥ã€Œè·Ÿè¯»è®­ç»ƒã€é¡µé¢ï¼š
   - ç‚¹å‡»ã€Œæ’­æ”¾ç¤ºä¾‹ã€ï¼Œå‰ç«¯ä¼šè°ƒç”¨ `/tts` å¹¶æ’­æ”¾å ä½éŸ³é¢‘ã€‚
   - ç‚¹å‡»ã€Œå¼€å§‹å½•éŸ³ã€ï¼Œå®Œæˆåè‡ªåŠ¨ä¸Šä¼  `/asr/recognize`ï¼Œå±•ç¤º Mock è¯†åˆ«æ–‡æœ¬ã€å¾—åˆ†ä¸æ˜Ÿçº§ã€‚
4. è¿›å…¥ã€Œäº”åéŸ³æµ‹éªŒã€é¡µé¢ï¼š
   - è¾“å…¥ç½—é©¬éŸ³å¹¶æäº¤ï¼ŒåŸºäºç¼–è¾‘è·ç¦»è®¡ç®—å‡†ç¡®ç‡ä¸æ˜Ÿçº§ã€‚
   - ç‚¹å‡»ã€ŒæŸ¥çœ‹å†å²ã€è·³è½¬ç»“æœé¡µï¼Œå¯æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡æµ‹éªŒä¸è·Ÿè¯»æˆç»©ã€‚

> å›¾ç¤ºå ä½ï¼šè¯·åœ¨æœ¬åœ°è”è°ƒåè‡ªè¡Œæˆªå–ã€Œé¦–é¡µã€ã€Œæµ‹éªŒã€ã€Œè·Ÿè¯»ã€é¡µé¢æˆªå›¾æ’å…¥æ–‡æ¡£ï¼ˆæ­¤å¤„ä¸é™„å¸¦çœŸå®å›¾ç‰‡ï¼Œé¿å…æäº¤äºŒè¿›åˆ¶æ–‡ä»¶ï¼‰ã€‚

## æµ‹è¯•å‘½ä»¤ä¸é¢„æœŸè¾“å‡º
æœåŠ¡ç«¯é›†æˆ Vitest å•å…ƒæµ‹è¯•ï¼Œè¦†ç›–ç¼–è¾‘è·ç¦»ã€WER ä¸æ˜Ÿçº§æ˜ å°„ã€‚

```bash
pnpm test
```

å…¸å‹è¾“å‡ºç¤ºä¾‹ï¼ˆæ–‡æœ¬ï¼‰
```
> pnpm -C server test

 DEV  v1.5.0 /workspace/kana-caoch/server
 âœ“ score utilities (4)  12ms

 Test Files  1 passed (1)
      Tests  4 passed (4)
   Start at  15:42:01
   Duration  800ms
```
è‹¥æ–°å¢ç®—æ³•æˆ–é˜ˆå€¼ï¼Œè¯·åŒæ—¶åœ¨ `server/src/tests/score.test.ts` ç¼–å†™å¯¹åº”æ–­è¨€å¹¶è¿è¡Œä¸Šè¿°å‘½ä»¤ã€‚

## `.gitignore` ä¸ `.gitattributes`
- `.gitignore` æ˜ç¡®æ’é™¤ `node_modules/`ã€æ„å»ºäº§ç‰©ã€å¾®ä¿¡å¼€å‘è€…å·¥å…·ç¼“å­˜ä»¥åŠå¸¸è§éŸ³è§†é¢‘/å‹ç¼©åŒ…/å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç¡®ä¿ä»“åº“ä¿æŒçº¯æ–‡æœ¬ã€‚
- `.gitattributes` å¼€å¯ `text=auto`ï¼Œå¹¶å°†æ‰€æœ‰å¸¸è§äºŒè¿›åˆ¶åç¼€æ ‡è®°ä¸º `-text`ï¼Œé˜²æ­¢ Git è¯¯åˆ¤ç¼–ç åŠæäº¤ã€‚

## ä»£ç é£æ ¼ä¸æäº¤è§„èŒƒ
- ç»Ÿä¸€ä½¿ç”¨ Prettierï¼ˆ`printWidth=100`ã€å•å¼•å·ã€ä¿ç•™åˆ†å·ï¼‰ã€‚
- TypeScript å¼ºåˆ¶å¼€å¯ `strict`ï¼Œå¯¼å‡ºå‡½æ•°éœ€åŒ…å« JSDoc ä¸­æ–‡æ³¨é‡Šã€‚
- Commit Message å»ºè®®éµå¾ª `type(scope): summary`ï¼ˆä¾‹å¦‚ `feat(server): add tts route mock`ï¼‰ã€‚
- æ¨èåˆ†æ”¯ç­–ç•¥ï¼š`main` ç”¨äºç¨³å®šç‰ˆæœ¬ï¼ŒåŠŸèƒ½å¼€å‘åœ¨ `feature/*` åˆ†æ”¯å®Œæˆå¹¶é€šè¿‡ PR åˆå¹¶ã€‚

## å¸¸è§é—®é¢˜ FAQ
1. **å°ç¨‹åºå½•éŸ³å¤±è´¥**ï¼šé¦–æ¬¡å½•éŸ³éœ€åœ¨é¢„è§ˆå™¨æˆ–çœŸæœºæˆæƒï¼Œè‹¥æˆæƒå¼¹çª—è¢«å¿½ç•¥ï¼Œå¯åœ¨è®¾ç½®ä¸­é‡æ–°å¼€å¯éº¦å…‹é£æƒé™ã€‚
2. **iOS å½•éŸ³æ—¶é•¿å—é™**ï¼šiOS å¯¹åå°å½•éŸ³æœ‰ä¸¥æ ¼é™åˆ¶ï¼Œå»ºè®®ä¿æŒç•Œé¢å¸¸äº®ï¼Œå¹¶æ§åˆ¶ 10 ç§’å†…å®Œæˆç»ƒä¹ ã€‚
3. **Mock æœåŠ¡è·¨åŸŸé—®é¢˜**ï¼šå·²åœ¨ Express å±‚å¯ç”¨ `cors`ï¼Œè‹¥ä»æç¤ºç½‘ç»œé”™è¯¯ï¼Œè¯·ç¡®è®¤å¼€å‘è€…å·¥å…·ã€Œä¸æ ¡éªŒåˆæ³•åŸŸåã€å·²å‹¾é€‰ã€‚
4. **ç«¯å£å†²çª**ï¼šé»˜è®¤ä½¿ç”¨ `3000` ç«¯å£ï¼Œå¯åœ¨ `.env` æˆ–å¯åŠ¨å‘½ä»¤ä¸­è®¾ç½® `PORT=xxxx pnpm dev:server`ã€‚
5. **å¼±ç½‘æˆ–ç¦»çº¿**ï¼šTTS/ASR éƒ½æ˜¯ Mockï¼Œç¦»çº¿æƒ…å†µä¸‹æŒ‰é’®ä¼šæç¤ºå¤±è´¥ï¼Œå¯åœ¨ README çš„è”è°ƒæ­¥éª¤ä¸­æŸ¥çœ‹é‡è¯•ç­–ç•¥ã€‚

## è…¾è®¯äº‘ TTS / ASR / COS å¯¹æ¥æŒ‡å¼•
### å‡†å¤‡å·¥ä½œ
1. åœ¨è…¾è®¯äº‘å¼€é€š **è¯­éŸ³åˆæˆ TTS**ã€**è¯­éŸ³è¯†åˆ« ASR**ã€**å¯¹è±¡å­˜å‚¨ COS**ã€‚
2. åˆ›å»ºæœ€å°æƒé™çš„ CAM å­è´¦å·ï¼Œè·å– `SecretId` ä¸ `SecretKey`ï¼Œå­˜æ”¾äºæœåŠ¡å™¨ç¯å¢ƒå˜é‡ã€‚
3. è‹¥éœ€å®¢æˆ·ç«¯ç›´ä¼  COSï¼Œéœ€å¯ç”¨ä¸´æ—¶å¯†é’¥ï¼ˆSTSï¼‰å¹¶å®ç°ç­¾åæœåŠ¡ã€‚

### TTS æ¥å…¥ä¼ªä»£ç 
```ts
import tencentcloud from 'tencentcloud-sdk-nodejs-tts';

const client = new tencentcloud.tts.v20190823.Client({
  credential: { secretId: process.env.TENCENT_SECRET_ID!, secretKey: process.env.TENCENT_SECRET_KEY! },
  region: 'ap-hongkong',
});

async function realTts(text: string) {
  const params = { Text: text, SessionId: crypto.randomUUID(), VoiceType: 1017 };
  const res = await client.TextToVoice(params);
  await cos.putObject({ Key: `tts/${params.SessionId}.mp3`, Body: Buffer.from(res.Audio, 'base64') });
  return `https://your-cdn/tts/${params.SessionId}.mp3`;
}
```
- å»ºè®®å¯ç”¨ CDN + é‰´æƒæŸ¥è¯¢å‚æ•°ï¼ŒéŸ³é¢‘æœ‰æ•ˆæœŸåº”ä¸ç»ƒä¹ åœºæ™¯åŒ¹é…ã€‚

### ASR æ¥å…¥ä¼ªä»£ç 
```ts
import tencentcloud from 'tencentcloud-sdk-nodejs-asr';

const client = new tencentcloud.asr.v20190614.Client({
  credential: { secretId: process.env.TENCENT_SECRET_ID!, secretKey: process.env.TENCENT_SECRET_KEY! },
  region: 'ap-hongkong',
});

async function realAsr(buffer: Buffer) {
  const res = await client.SentenceRecognition({
    EngSerViceType: '16k_zh',
    SourceType: 1,
    VoiceFormat: 'mp3',
    Data: buffer.toString('base64'),
  });
  return res.Result?.Text ?? '';
}
```
- è‹¥éŸ³é¢‘è¾ƒå¤§å¯ä½¿ç”¨æµå¼è¯†åˆ«ï¼ˆWebSocketï¼‰æˆ– COS URL æ¨¡å¼ã€‚
- æ³¨æ„è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œå»ºè®®å®ç°é˜Ÿåˆ—æˆ–ç†”æ–­ç­–ç•¥ã€‚

### COS ä¸Šä¼ ä¸å›æº
```ts
import COS from 'cos-nodejs-sdk-v5';

const cos = new COS({ SecretId: process.env.TENCENT_SECRET_ID!, SecretKey: process.env.TENCENT_SECRET_KEY! });

async function uploadAudio(key: string, data: Buffer) {
  await cos.putObject({ Bucket: process.env.COS_BUCKET!, Region: process.env.COS_REGION!, Key: key, Body: data });
  return `https://${process.env.COS_BUCKET!}.cos.${process.env.COS_REGION!}.myqcloud.com/${key}`;
}
```
- å»ºè®®ç»“åˆ CDNã€è‡ªå®šä¹‰åŸŸåå’Œé˜²ç›—é“¾ç­–ç•¥ã€‚
- å¯¹æ•æ„ŸéŸ³é¢‘å¯ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå®šæœŸæ¸…ç†ã€‚

## éƒ¨ç½²ä¸å®‰å…¨å»ºè®®
- ä½¿ç”¨ `.env` ç®¡ç†å¯†é’¥ï¼Œåˆ‡å‹¿å°†æ•æ„Ÿä¿¡æ¯å†™å…¥ä»£ç åº“ã€‚
- ç”Ÿäº§ç¯å¢ƒä¸­ä»…å¼€æ”¾å¿…è¦ç«¯å£ï¼Œé…åˆ WAF/é€Ÿç‡é™åˆ¶é˜²æ­¢æ»¥ç”¨ã€‚
- å¯¹è®¿é—®æ—¥å¿—åšè„±æ•å¤„ç†ï¼Œéµå®ˆæ‰€åœ¨åœ°éšç§æ³•è§„ã€‚
- å»ºè®®å¯ç”¨ HTTPS ä¸ HSTSï¼Œé˜²æ­¢ä¸­é—´äººæ”»å‡»ã€‚

## æ— éšœç¢ä¸å¯ç”¨æ€§å»ºè®®
- æ˜Ÿçº§ç»„ä»¶å·²æ·»åŠ  `aria-label`ï¼Œä¾¿äºå±å¹•é˜…è¯»å™¨æœ—è¯»è¯„åˆ†ã€‚
- å¯¹å½•éŸ³ã€æ’­æ”¾å¤±è´¥çš„åœºæ™¯æä¾› `wx.showToast` æç¤ºï¼Œå¼±ç½‘æ—¶å¼•å¯¼é‡è¯•ã€‚
- é¡µé¢æŒ‰é’®å°ºå¯¸ â‰¥44pxï¼Œä¿è¯è§¦æ§å¯è¾¾æ€§ï¼›è¡¨å•æ§ä»¶æ”¯æŒé”®ç›˜å¯¼èˆªã€‚
- å¯æ ¹æ®éœ€è¦æ–°å¢ç¦»çº¿ç¼“å­˜ç­–ç•¥ï¼Œä¾‹å¦‚å°†ä¾‹å¥æ•°æ®å†™å…¥ Storageã€‚

## å…è´£å£°æ˜
æœ¬é¡¹ç›®ä»…ç”¨äºæ•™å­¦ä¸æ¼”ç¤ºï¼Œæ‰€æœ‰éŸ³é¢‘ä¸è¯†åˆ«ç»“æœå‡ä¸ºå ä½ Mock æ•°æ®ã€‚å®é™…ä¸šåŠ¡æ¥å…¥è…¾è®¯äº‘æˆ–å…¶ä»–äº‘æœåŠ¡æ—¶ï¼Œè¯·éµå¾ªç›¸å…³æ³•å¾‹æ³•è§„ï¼Œå¦¥å–„å¤„ç†ç”¨æˆ·éšç§ä¸è‘—ä½œæƒé—®é¢˜ã€‚

